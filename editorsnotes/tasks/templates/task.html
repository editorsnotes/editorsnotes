{% extends "base.html" %}

{% load typogrify display %}

{% block js %}
<script type="text/javascript" src="/media/function/json2.js"></script>
<script type="text/javascript" src="/media/function/wymeditor/jquery.wymeditor.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $('#task a.model-link').attr('target', '_blank');
  var attachmentCounter = 1;
  $('#comment-attachments-add').click(function() {
    var attachmentTitle = 'comment-attachment-' + attachmentCounter
    var selector = $('#comment-attachment-categories').clone().show()
      .attr({'id' : attachmentTitle + '-category', 'class' : 'attachment-categories'});
    var attachment = $('<div>')
        .attr({'id' : attachmentTitle, 'class' : 'attachment'})
        .append(selector)
        .append('<input class="attachment-item" type="text"><input class="attachment-id" type="hidden" name="attachment">');
    $('.attachment-item', attachment).autocomplete(autocompleteOpts('notes', attachment));
    $('#comment-attachments').append(attachment);
    attachmentCounter++;
  });
  
  $('.attachment-categories').live('change', function() {
    var container = $(this);
    container.next('.attachment-item').autocomplete(autocompleteOpts(container.val(), container.parent()));
  });
  
  var autocompleteOpts = function(src, $container){
    var JSONreturn = {'topics' : 'preferred_name', 'notes' : 'description', 'documents' : 'description'}
    return {
      source: function(request, response) {
        $.getJSON('/api/'+ src + '/', { q: request.term }, function(data) {
          response($.map(data, function(item, index) {
            return { label: item[JSONreturn[src]], id: item.id };
          }));
        });
      },
      position: 'above',
      minLength: 2,
      select: function(event, ui) {
        if (ui.item) {
          $container.find('input.attachment-id').val(src + ' ' + ui.item.id);
        }
      }
    }
  }

});

</script>
{% endblock %}

{% block css %}
<style type="text/css">
.comment {
    border-top: 1px solid #BBB;
    padding: .5em 0;
}
.attachment-item {
    margin-left: 1em !important;
    width: 400px;
}
.comment-attachments {
    border: 1px dashed #EEE;
    border-radius: 2px;
    padding: 10px;
}
.comment-attachments .model-link{
    font-size: 13px;
}
#task-description {margin-bottom: 2em;}
</style>
{% endblock %}

{% block content %}
<section id="task" class="span-18 last">
  <div id="task-description" class="span-18">
    <h3>{{ task.title }}</h3>
    <p>{{ task.description }}</p>
    {{ task|display_edit_history }}
  </div>
  <div id="comments" class="span-18">
    <div id="comments-stripe">
      <h5 class="bottom">Comments</h5>
    </div>
    {% for comment in task.comments.all %}
      <div class="comment">
        <p>{{ comment.text|escape }}</p>
        {% if comment.has_attachments %}
          <ul class="comment-attachments">
            <h6>Attachments</h6>
            <table class="bottom">
          {% for attachment in comment.attachments.all %}
              <li><tr><td><em>{{ attachment.content_type|title }}</em></td><td>{{ attachment.content_object|as_link }}</td></tr></li>
          {% endfor %}
            </table>
          </ul>
        {% endif %}
        <div class="quiet">by {{ comment.creator.get_profile|as_link }} on {{ comment.created|date:"M d Y, g:iA T" }}</div>
      </div>
    {% endfor %}
  </div>
  {% if user.is_authenticated %}
  <form id="add-comment" class="span-18" action="comment/?return_to={{ task.get_absolute_url }}" method="POST">
    {% csrf_token %}
    <span class="large">Add comment:</span>
    <div id="comment-text-container" class="span-18">
      <textarea class="span-18 first" style="height:7em;" name="comment-text"></textarea>
    </div>
    <div id="comment-attachments" class="span-18">
      <select id="comment-attachment-categories" style="display: none;">
        <option value="notes">Note</option>
        <option value="topics">Topic</option>
        <option value="documents">Document</option>
      </select>
    </div>
    <button type="button" id="comment-attachments-add">Add attachment</button>
    <span class="span-18" style="margin-top: 1.5em">
      <button type="submit" id="submit-comment">Submit</button>
    </span>
  </form>
  {% endif %}
</section>


{% endblock %}
