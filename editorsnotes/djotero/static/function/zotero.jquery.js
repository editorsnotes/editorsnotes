EditorsNotes.CSL = {};

EditorsNotes.CSL.createCSLEngine = function(format) {
  var sys
    , citeproc
    , dateParser
    , bibdata = {}
    , locales = EditorsNotes.CSL.locales
    , runCite

  sys = {
    retrieveItem: function(id){ return bibdata[id]; },
    retrieveLocale: function(lang){ return locales[lang]; }
  }

  CSL.Output.Formats.text["@font-style/italic"] = "<em>%%STRING%%</em>";

  citeproc = new CSL.Engine(sys, EditorsNotes.CSL.formats[format]);
  citeproc.setOutputFormat("text");

  dateParser = new CSL.DateParser;

  runCite = function(cslItem) {
    if (!cslItem.hasOwnProperty('id')) {
      cslItem.id = 'ITEM';
    }
    bibdata[cslItem.id] = cslItem;
    return citeproc.previewCitationCluster({
      'citationItems': [ {'id': cslItem.id} ],
      'properties': {}
    }, [], [], 'text');
  }

  return runCite;
};

EditorsNotes.CSL.locales = {"en-US":"<locale xml:lang=\"en\" xmlns=\"http://purl.org/net/xbiblio/csl\">  <style-options punctuation-in-quote=\"true\"/>  <date form=\"text\">    <date-part name=\"month\" suffix=\" \"/>    <date-part name=\"day\" suffix=\", \"/>    <date-part name=\"year\"/>  </date>  <date form=\"numeric\">    <date-part name=\"year\"/>    <date-part name=\"month\" form=\"numeric\" prefix=\"-\" range-delimiter=\"/\"/>    <date-part name=\"day\" prefix=\"-\" range-delimiter=\"/\"/>  </date>  <terms>    <term name=\"document-number-label\">No.</term>    <term name=\"document-number-authority-suffix\">Doc.</term>    <term name=\"un-sales-number-label\">U.N. Sales No.</term>    <term name=\"collection-number-label\">No.</term>    <term name=\"open-quote\">\u201c</term>    <term name=\"close-quote\">\u201d</term>    <term name=\"open-inner-quote\">\u2018</term>    <term name=\"close-inner-quote\">\u2019</term>    <term name=\"ordinal-01\">st</term>    <term name=\"ordinal-02\">nd</term>    <term name=\"ordinal-03\">rd</term>    <term name=\"ordinal-04\">th</term>    <term name=\"long-ordinal-01\">first</term>    <term name=\"long-ordinal-02\">second</term>    <term name=\"long-ordinal-03\">third</term>    <term name=\"long-ordinal-04\">fourth</term>    <term name=\"long-ordinal-05\">fifth</term>    <term name=\"long-ordinal-06\">sixth</term>    <term name=\"long-ordinal-07\">seventh</term>    <term name=\"long-ordinal-08\">eighth</term>    <term name=\"long-ordinal-09\">ninth</term>    <term name=\"long-ordinal-10\">tenth</term>    <term name=\"at\">at</term>    <term name=\"in\">in</term>    <term name=\"ibid\">ibid</term>    <term name=\"accessed\">accessed</term>    <term name=\"retrieved\">retrieved</term>    <term name=\"from\">from</term>    <term name=\"forthcoming\">forthcoming</term>    <term name=\"references\">      <single>reference</single>      <multiple>references</multiple>    </term>    <term name=\"references\" form=\"short\">      <single>ref</single>      <multiple>refs</multiple>    </term>    <term name=\"no date\">n.d.</term>    <term name=\"and\">and</term>    <term name=\"et-al\">et al.</term>    <term name=\"interview\">interview</term>    <term name=\"letter\">letter</term>    <term name=\"anonymous\">anonymous</term>    <term name=\"anonymous\" form=\"short\">anon.</term>    <term name=\"and others\">and others</term>    <term name=\"in press\">in press</term>    <term name=\"online\">online</term>    <term name=\"cited\">cited</term>    <term name=\"internet\">internet</term>    <term name=\"presented at\">presented at the</term>    <term name=\"ad\">AD</term>    <term name=\"bc\">BC</term>    <term name=\"season-01\">Spring</term>    <term name=\"season-02\">Summer</term>    <term name=\"season-03\">Autumn</term>    <term name=\"season-04\">Winter</term>    <term name=\"with\">with</term>        <!-- CATEGORIES -->    <term name=\"anthropology\">anthropology</term>    <term name=\"astronomy\">astronomy</term>    <term name=\"biology\">biology</term>    <term name=\"botany\">botany</term>    <term name=\"chemistry\">chemistry</term>    <term name=\"engineering\">engineering</term>    <term name=\"generic-base\">generic base</term>    <term name=\"geography\">geography</term>    <term name=\"geology\">geology</term>    <term name=\"history\">history</term>    <term name=\"humanities\">humanities</term>    <term name=\"literature\">literature</term>    <term name=\"math\">math</term>    <term name=\"medicine\">medicine</term>    <term name=\"philosophy\">philosophy</term>    <term name=\"physics\">physics</term>    <term name=\"psychology\">psychology</term>    <term name=\"sociology\">sociology</term>    <term name=\"science\">science</term>    <term name=\"political_science\">political science</term>    <term name=\"social_science\">social science</term>    <term name=\"theology\">theology</term>    <term name=\"zoology\">zoology</term>        <!-- LONG LOCATOR FORMS -->    <term name=\"book\">      <single>book</single>      <multiple>books</multiple>    </term>    <term name=\"chapter\">      <single>chapter</single>      <multiple>chapters</multiple>    </term>    <term name=\"column\">      <single>column</single>      <multiple>columns</multiple>    </term>    <term name=\"figure\">      <single>figure</single>      <multiple>figures</multiple>    </term>    <term name=\"folio\">      <single>folio</single>      <multiple>folios</multiple>    </term>    <term name=\"issue\">      <single>number</single>      <multiple>numbers</multiple>    </term>    <term name=\"line\">      <single>line</single>      <multiple>lines</multiple>    </term>    <term name=\"note\">      <single>note</single>      <multiple>notes</multiple>    </term>    <term name=\"opus\">      <single>opus</single>      <multiple>opera</multiple>    </term>    <term name=\"page\">      <single>page</single>      <multiple>pages</multiple>    </term>    <term name=\"paragraph\">      <single>paragraph</single>      <multiple>paragraph</multiple>    </term>    <term name=\"part\">      <single>part</single>      <multiple>parts</multiple>    </term>    <term name=\"section\">      <single>section</single>      <multiple>sections</multiple>    </term>    <term name=\"volume\">      <single>volume</single>      <multiple>volumes</multiple>    </term>    <term name=\"edition\">      <single>edition</single>      <multiple>editions</multiple>    </term>    <term name=\"verse\">      <single>verse</single>      <multiple>verses</multiple>    </term>    <term name=\"sub verbo\">      <single>sub verbo</single>      <multiple>s.vv</multiple>    </term>        <!-- SHORT LOCATOR FORMS -->    <term name=\"book\" form=\"short\">bk.</term>    <term name=\"chapter\" form=\"short\">chap.</term>    <term name=\"column\" form=\"short\">col.</term>    <term name=\"figure\" form=\"short\">fig.</term>    <term name=\"folio\" form=\"short\">f.</term>    <term name=\"issue\" form=\"short\">no.</term>    <term name=\"opus\" form=\"short\">op.</term>    <term name=\"page\" form=\"short\">      <single>p.</single>      <multiple>pp.</multiple>    </term>    <term name=\"paragraph\" form=\"short\">para.</term>    <term name=\"part\" form=\"short\">pt.</term>    <term name=\"section\" form=\"short\">sec.</term>    <term name=\"sub verbo\" form=\"short\">      <single>s.v.</single>      <multiple>s.vv.</multiple>    </term>    <term name=\"verse\" form=\"short\">      <single>v.</single>      <multiple>vv.</multiple>    </term>    <term name=\"volume\" form=\"short\">    	<single>vol.</single>    	<multiple>vols.</multiple>    </term>    <term name=\"edition\">edition</term>    <term name=\"edition\" form=\"short\">ed.</term>        <!-- SYMBOL LOCATOR FORMS -->    <term name=\"paragraph\" form=\"symbol\">      <single>¶</single>      <multiple>¶¶</multiple>    </term>    <term name=\"section\" form=\"symbol\">      <single>§</single>      <multiple>§§</multiple>    </term>        <!-- LONG ROLE FORMS -->    <term name=\"author\">      <single></single>      <multiple></multiple>    </term>    <term name=\"editor\">      <single>editor</single>      <multiple>editors</multiple>    </term>    <term name=\"translator\">      <single>translator</single>      <multiple>translators</multiple>    </term>        <!-- SHORT ROLE FORMS -->    <term name=\"author\" form=\"short\">      <single></single>      <multiple></multiple>    </term>    <term name=\"editor\" form=\"short\">      <single>ed.</single>      <multiple>eds.</multiple>    </term>    <term name=\"translator\" form=\"short\">      <single>tran.</single>      <multiple>trans.</multiple>    </term>        <!-- VERB ROLE FORMS -->    <term name=\"editor\" form=\"verb\">edited by</term>    <term name=\"translator\" form=\"verb\">translated by</term>    <term name=\"recipient\" form=\"verb\">to</term>    <term name=\"interviewer\" form=\"verb\">interview by</term>        <!-- SHORT VERB ROLE FORMS -->    <term name=\"editor\" form=\"verb-short\">ed.</term>    <term name=\"translator\" form=\"verb-short\">trans.</term>        <!-- LONG MONTH FORMS -->    <term name=\"month-01\">January</term>    <term name=\"month-02\">February</term>    <term name=\"month-03\">March</term>    <term name=\"month-04\">April</term>    <term name=\"month-05\">May</term>    <term name=\"month-06\">June</term>    <term name=\"month-07\">July</term>    <term name=\"month-08\">August</term>    <term name=\"month-09\">September</term>    <term name=\"month-10\">October</term>    <term name=\"month-11\">November</term>    <term name=\"month-12\">December</term>        <!-- SHORT MONTH FORMS -->    <term name=\"month-01\" form=\"short\">Jan.</term>    <term name=\"month-02\" form=\"short\">Feb.</term>    <term name=\"month-03\" form=\"short\">Mar.</term>    <term name=\"month-04\" form=\"short\">Apr.</term>	<term name=\"month-05\" form=\"short\">May</term>    <term name=\"month-06\" form=\"short\">Jun.</term>    <term name=\"month-07\" form=\"short\">Jul.</term>    <term name=\"month-08\" form=\"short\">Aug.</term>    <term name=\"month-09\" form=\"short\">Sep.</term>    <term name=\"month-10\" form=\"short\">Oct.</term>    <term name=\"month-11\" form=\"short\">Nov.</term>    <term name=\"month-12\" form=\"short\">Dec.</term>  </terms></locale>"};

// this is a style from demo.html
EditorsNotes.CSL.formats = {};
EditorsNotes.CSL.formats.chicago_fullnote_bibliography2 = "<style       xmlns=\"http://purl.org/net/xbiblio/csl\"      class=\"note\"   page-range-format=\"chicago\" default-locale=\"en-US-x-sort-ja-alalc97-x-sec-en-x-pri-ja-alalc97\">  <info>    <title>Chicago Manual of Style (Full Note with Bibliography)</title>    <id>http://www.zotero.org/styles/chicago-fullnote-bibliography</id>    <link href=\"http://www.zotero.org/styles/chicago-fullnote-bibliography\" />    <link href=\"http://www.chicagomanualofstyle.org/tools_citationguide.html\" rel=\"documentation\" />    <author>      <name>Julian Onions</name>      <email>julian.onions@gmail.com</email>    </author>    <contributor>      <name>Simon Kornblith</name>      <email>simon@simonster.com</email>    </contributor>    <contributor>      <name>Elena Razlogova</name>      <email>elena.razlogova@gmail.com</email>    </contributor>    <summary>Chicago format with full notes and bibliography</summary>    <category term=\"generic-base\" />    <category term=\"numeric\" />    <updated />  </info>  <locale>	<style-options punctuation-in-quote=\"false\"/></locale><macro name=\"editor-translator\">    <group delimiter=\", \">      <choose>        <if variable=\"author\">          <names delimiter=\", \" variable=\"editor\">            <label form=\"verb-short\" suffix=\". \" text-case=\"lowercase\" />            <name and=\"text\" delimiter=\", \" />          </names>        </if>      </choose>      <choose>        <if match=\"any\" variable=\"author editor\">          <names delimiter=\", \" variable=\"translator\">            <label form=\"verb-short\" suffix=\". \" text-case=\"lowercase\" />            <name and=\"text\" delimiter=\", \" />          </names>        </if>      </choose>    </group>  </macro>  <macro name=\"secondary-contributors-note\">    <choose>      <if match=\"none\" type=\"chapter\">        <text macro=\"editor-translator\" />      </if>    </choose>  </macro>  <macro name=\"container-contributors-note\">    <choose>      <if type=\"chapter\">        <text macro=\"editor-translator\" />      </if>    </choose>  </macro>  <macro name=\"secondary-contributors\">    <choose>      <if match=\"none\" type=\"chapter\">        <group delimiter=\". \">          <choose>            <if variable=\"author\">              <names delimiter=\". \" variable=\"editor\">                <label form=\"verb\" prefix=\" \" suffix=\" \" text-case=\"capitalize-first\" />                <name and=\"text\" delimiter=\", \" />              </names>            </if>          </choose>          <choose>            <if match=\"any\" variable=\"author editor\">              <names delimiter=\". \" variable=\"translator\">                <label form=\"verb\" prefix=\" \" suffix=\" \" text-case=\"capitalize-first\" />                <name and=\"text\" delimiter=\", \" />              </names>            </if>          </choose>        </group>      </if>    </choose>  </macro>  <macro name=\"container-contributors\">    <choose>      <if type=\"chapter\">        <group delimiter=\", \">          <choose>            <if variable=\"author\">              <names delimiter=\", \" variable=\"editor\">                <label form=\"verb\" suffix=\" \" text-case=\"lowercase\" />                <name and=\"text\" delimiter=\", \" />              </names>            </if>          </choose>          <choose>            <if match=\"any\" variable=\"author editor\">              <names delimiter=\", \" variable=\"translator\">                <label form=\"verb\" suffix=\" \" text-case=\"lowercase\" />                <name and=\"text\" delimiter=\", \" />              </names>            </if>          </choose>        </group>      </if>    </choose>  </macro>  <macro name=\"editor-note\">    <names variable=\"editor\">      <name and=\"text\" delimiter=\", \" sort-separator=\", \" />      <label form=\"short\" prefix=\", \" suffix=\".\" />    </names>  </macro>  <macro name=\"translator-note\">    <names variable=\"translator\">      <name and=\"text\" delimiter=\", \" sort-separator=\", \" />      <label form=\"verb-short\" prefix=\", \" suffix=\".\" />    </names>  </macro>  <macro name=\"recipient-note\">    <names delimiter=\", \" variable=\"recipient\">      <label form=\"verb\" prefix=\" \" suffix=\" \" text-case=\"lowercase\" />      <name and=\"text\" delimiter=\", \" />    </names>  </macro>  <macro name=\"contributors-note\">    <names variable=\"author\">      <name and=\"text\" delimiter=\", \" sort-separator=\", \" />      <substitute>        <text macro=\"editor-note\" />        <text macro=\"translator-note\" />      </substitute>    </names>    <text macro=\"recipient-note\" />  </macro>  <macro name=\"editor\">    <names variable=\"editor\">      <name and=\"text\" delimiter=\", \" delimiter-precedes-last=\"always\" name-as-sort-order=\"first\" sort-separator=\", \" />      <label form=\"short\" prefix=\", \" suffix=\".\" />    </names>  </macro>  <macro name=\"translator\">    <names variable=\"translator\">      <name and=\"text\" delimiter=\", \" delimiter-precedes-last=\"always\" name-as-sort-order=\"first\" sort-separator=\", \" />      <label form=\"verb-short\" prefix=\", \" suffix=\".\" />    </names>  </macro>  <macro name=\"recipient\">    <choose>      <if type=\"personal_communication\">        <choose>          <if variable=\"genre\">            <text text-case=\"capitalize-first\" variable=\"genre\" />          </if>          <else>            <text term=\"letter\" text-case=\"capitalize-first\" />          </else>        </choose>      </if>    </choose>    <text macro=\"recipient-note\" prefix=\" \" />  </macro>  <macro name=\"contributors\">    <names variable=\"author\">      <name and=\"text\" delimiter=\", \" delimiter-precedes-last=\"always\" name-as-sort-order=\"first\" sort-separator=\", \" />      <substitute>        <text macro=\"editor\" />        <text macro=\"translator\" />      </substitute>    </names>    <text macro=\"recipient\" prefix=\". \" />  </macro>  <macro name=\"recipient-short\">    <names variable=\"recipient\">      <label form=\"verb\" prefix=\" \" suffix=\" \" text-case=\"lowercase\" />      <name and=\"text\" delimiter=\", \" form=\"short\" />    </names>  </macro>  <macro name=\"contributors-short\">    <names variable=\"author\">      <name and=\"text\" delimiter=\", \" form=\"short\" />      <substitute>        <names variable=\"editor\" />        <names variable=\"translator\" />      </substitute>    </names>    <text macro=\"recipient-short\" />  </macro>  <macro name=\"contributors-sort\">    <names variable=\"author\">      <name and=\"text\" delimiter=\", \" delimiter-precedes-last=\"always\" name-as-sort-order=\"all\" sort-separator=\", \" />      <label form=\"verb-short\" prefix=\", \" suffix=\".\" />      <substitute>        <names variable=\"editor\" />        <names variable=\"translator\" />      </substitute>    </names>  </macro>  <macro name=\"interviewer-note\">    <names delimiter=\", \" variable=\"interviewer\">      <label form=\"verb\" prefix=\" \" suffix=\" \" text-case=\"lowercase\" />      <name and=\"text\" delimiter=\", \" />    </names>  </macro>  <macro name=\"interviewer\">    <names delimiter=\", \" variable=\"interviewer\">      <label form=\"verb\" prefix=\" \" suffix=\" \" text-case=\"capitalize-first\" />      <name and=\"text\" delimiter=\", \" />    </names>  </macro>  <macro name=\"title-note\">    <choose>      <if match=\"none\" variable=\"title\">        <text variable=\"genre\" />      </if>      <else-if type=\"book\">        <text font-style=\"italic\" variable=\"title\" />      </else-if>      <else>        <text quotes=\"true\" variable=\"title\" />      </else>    </choose>  </macro>  <macro name=\"title\">    <choose>      <if match=\"none\" variable=\"title\">        <choose>          <if match=\"none\" type=\"personal_communication\">            <text text-case=\"capitalize-first\" variable=\"genre\" />          </if>        </choose>      </if>      <else-if type=\"book\">        <text font-style=\"italic\" variable=\"title\" />      </else-if>      <else>        <text quotes=\"true\" variable=\"title\" />      </else>    </choose>  </macro>  <macro name=\"title-short\">    <choose>      <if match=\"none\" variable=\"title\">        <choose>          <if type=\"interview\">            <text term=\"interview\" text-case=\"lowercase\" />          </if>          <else-if match=\"any\" type=\"manuscript speech\">            <text form=\"short\" variable=\"genre\" />          </else-if>          <else-if type=\"personal_communication\">            <text macro=\"issued\" />          </else-if>        </choose>      </if>      <else-if type=\"book\">        <text font-style=\"italic\" form=\"short\" variable=\"title\" />      </else-if>      <else>        <text form=\"short\" quotes=\"true\" variable=\"title\" />      </else>    </choose>  </macro>  <macro name=\"description-note\">    <group delimiter=\", \">      <text macro=\"interviewer-note\" />      <text variable=\"medium\" />      <choose>        <if match=\"none\" variable=\"title\"> </if>        <else-if match=\"any\" type=\"thesis speech\"> </else-if>        <else>          <text variable=\"genre\" />        </else>      </choose>    </group>  </macro>  <macro name=\"description\">    <group delimiter=\", \">      <group delimiter=\". \">        <text macro=\"interviewer\" />        <text text-case=\"capitalize-first\" variable=\"medium\" />      </group>      <choose>        <if match=\"none\" variable=\"title\"> </if>        <else-if match=\"any\" type=\"thesis speech\"> </else-if>        <else>          <text text-case=\"capitalize-first\" variable=\"genre\" />        </else>      </choose>    </group>  </macro>  <macro name=\"container-title-note\">    <choose>      <if type=\"chapter\">        <text suffix=\" \" term=\"in\" text-case=\"lowercase\" />      </if>    </choose>    <text font-style=\"italic\" variable=\"container-title\" form=\"short\"/>  </macro>  <macro name=\"container-title\">    <choose>      <if type=\"chapter\">        <text suffix=\" \" term=\"in\" text-case=\"capitalize-first\" />      </if>    </choose>    <text font-style=\"italic\" variable=\"container-title\" form=\"short\"/>  </macro>  <macro name=\"collection-title\">    <text variable=\"collection-title\" />    <text prefix=\" \" variable=\"collection-number\" />  </macro>  <macro name=\"edition-note\">    <choose>      <if match=\"any\" type=\"book chapter\">        <choose>          <if is-numeric=\"edition\">            <group delimiter=\" \">              <number form=\"ordinal\" variable=\"edition\" />              <text form=\"short\" suffix=\".\" term=\"edition\" />            </group>          </if>          <else>            <text suffix=\".\" variable=\"edition\" />          </else>        </choose>      </if>    </choose>  </macro>  <macro name=\"edition\">    <choose>      <if match=\"any\" type=\"book chapter\">        <choose>          <if is-numeric=\"edition\">            <group delimiter=\" \">              <number form=\"ordinal\" variable=\"edition\" />              <text form=\"short\" suffix=\".\" term=\"edition\" />            </group>          </if>          <else>            <text suffix=\".\" text-case=\"capitalize-first\" variable=\"edition\" />          </else>        </choose>      </if>    </choose>  </macro>  <macro name=\"locators-note\">    <choose>      <if type=\"article-journal\">        <text prefix=\" \" variable=\"volume\" />        <text prefix=\", no. \" variable=\"issue\" />      </if>      <else-if match=\"any\" type=\"book chapter\">        <group delimiter=\", \" prefix=\", \">          <group>            <text form=\"short\" suffix=\". \" term=\"volume\" />            <number form=\"numeric\" variable=\"volume\" />          </group>          <choose>            <if match=\"none\" variable=\"locator\">              <group>                <number form=\"numeric\" variable=\"number-of-volumes\" />                <text form=\"short\" plural=\"true\" prefix=\" \" suffix=\".\" term=\"volume\" />              </group>            </if>          </choose>          <text macro=\"edition-note\" />        </group>      </else-if>    </choose>  </macro>  <macro name=\"locators\">    <choose>      <if type=\"article-journal\">        <text prefix=\" \" variable=\"volume\" />        <text prefix=\", no. \" variable=\"issue\" />      </if>      <else-if match=\"any\" type=\"book\">        <group delimiter=\". \" prefix=\". \">          <group>            <text form=\"short\" suffix=\". \" term=\"volume\" text-case=\"capitalize-first\" />            <number form=\"numeric\" variable=\"volume\" />          </group>          <group>            <number form=\"numeric\" variable=\"number-of-volumes\" />            <text form=\"short\" plural=\"true\" prefix=\" \" suffix=\".\" term=\"volume\" />          </group>          <text macro=\"edition\" />        </group>      </else-if>    </choose>  </macro>  <macro name=\"locators-newspaper\">    <choose>      <if type=\"article-newspaper\">        <group delimiter=\", \">          <group>            <text suffix=\" \" variable=\"edition\" />            <text prefix=\" \" term=\"edition\" />          </group>          <group>            <text form=\"short\" suffix=\". \" term=\"section\" />            <text variable=\"section\" />          </group>        </group>      </if>    </choose>  </macro>  <macro name=\"event\">    <group>      <text suffix=\" \" term=\"presented at\" />      <text variable=\"event\" />    </group>  </macro>  <macro name=\"publisher\">    <group delimiter=\": \">      <text variable=\"publisher-place\" />      <text variable=\"publisher\" />    </group>  </macro>  <macro name=\"issued\">    <choose>      <if match=\"any\" type=\"graphic report\">        <date variable=\"issued\">          <date-part name=\"month\" suffix=\" \" />          <date-part name=\"day\" suffix=\", \" />          <date-part name=\"year\" />        </date>      </if>      <else-if match=\"any\" type=\"book chapter thesis\">        <date variable=\"issued\">          <date-part name=\"year\" />        </date>      </else-if>      <else>        <date variable=\"issued\">          <date-part name=\"month\" suffix=\" \" />          <date-part name=\"day\" suffix=\", \" />          <date-part name=\"year\" />        </date>      </else>    </choose>  </macro>  <macro name=\"point-locators-subsequent\">    <group>      <choose>        <if locator=\"page\" match=\"none\">          <label form=\"short\" strip-periods=\"false\" suffix=\" \" variable=\"locator\" />        </if>      </choose>      <text variable=\"locator\" />    </group>  </macro>  <macro name=\"point-locators\">    <choose>      <if match=\"none\" variable=\"locator\">        <text macro=\"pages\" />      </if>      <else-if type=\"article-journal\">        <text prefix=\": \" variable=\"locator\" />      </else-if>      <else>        <text macro=\"point-locators-subsequent\" prefix=\", \" />      </else>    </choose>  </macro>  <macro name=\"pages\">    <choose>      <if type=\"article-journal\">        <text prefix=\": \" variable=\"page\" />      </if>      <else-if type=\"chapter\">        <text prefix=\", \" variable=\"page\" />      </else-if>    </choose>  </macro>  <macro name=\"locators-chapter\">    <choose>      <if type=\"chapter\">        <text suffix=\":\" variable=\"volume\" />        <text variable=\"page\" />      </if>    </choose>  </macro>  <macro name=\"locators-journal\">    <choose>      <if type=\"article-journal\">        <text prefix=\": \" variable=\"page\" />      </if>    </choose>  </macro>  <macro name=\"archive-note\">    <group delimiter=\", \">      <text variable=\"archive_location\" />      <text variable=\"archive\" />      <text variable=\"archive-place\" />    </group>  </macro>  <macro name=\"archive\">    <group delimiter=\". \">      <text text-case=\"capitalize-first\" variable=\"archive_location\" />      <text variable=\"archive\" />      <text variable=\"archive-place\" />    </group>  </macro>  <macro name=\"issue-note\">    <choose>      <if type=\"article-journal\">        <text macro=\"issued\" prefix=\" (\" suffix=\")\" />      </if>      <else-if match=\"any\" variable=\"publisher-place publisher\">        <group delimiter=\", \" prefix=\" (\" suffix=\")\">          <group delimiter=\" \">            <choose>              <if match=\"none\" variable=\"title\"> </if>              <else-if match=\"any\" type=\"thesis speech\">                <text variable=\"genre\" />              </else-if>            </choose>            <text macro=\"event\" />          </group>          <text macro=\"publisher\" />          <text macro=\"issued\" />        </group>      </else-if>      <else>        <text macro=\"issued\" prefix=\", \" />      </else>    </choose>  </macro>  <macro name=\"issue\">    <choose>      <if type=\"article-journal\">        <text macro=\"issued\" prefix=\" (\" suffix=\")\" />      </if>      <else-if type=\"speech\">        <choose>          <if match=\"none\" variable=\"title\"> </if>          <else>            <text prefix=\". \" text-case=\"capitalize-first\" variable=\"genre\" />          </else>        </choose>        <text macro=\"event\" prefix=\" \" />        <text prefix=\", \" variable=\"event-place\" />        <text macro=\"issued\" prefix=\", \" />      </else-if>      <else-if match=\"any\" variable=\"publisher-place publisher\">        <group delimiter=\", \" prefix=\". \">          <choose>            <if type=\"thesis\">              <text text-case=\"capitalize-first\" variable=\"genre\" />            </if>          </choose>          <text macro=\"publisher\" />          <text macro=\"issued\" />        </group>      </else-if>      <else>        <text macro=\"issued\" prefix=\", \" />      </else>    </choose>  </macro>  <macro name=\"access-note\">    <group delimiter=\", \">      <choose>        <if match=\"any\" type=\"graphic report\">          <text macro=\"archive-note\" />        </if>        <else-if match=\"none\" type=\"book thesis chapter article-journal article-newspaper article-magazine\">          <text macro=\"archive-note\" />        </else-if>      </choose>      <text prefix=\"doi:\" variable=\"DOI\" />      <text variable=\"URL\" />    </group>  </macro>  <macro name=\"access\">    <group delimiter=\". \">      <choose>        <if match=\"any\" type=\"graphic report\">          <text macro=\"archive\" />        </if>        <else-if match=\"none\" type=\"book thesis chapter article-journal article-newspaper article-magazine\">          <text macro=\"archive\" />        </else-if>      </choose>      <text variable=\"URL\" />    </group>  </macro>  <macro name=\"sort-key\">    <text macro=\"contributors-sort\" suffix=\" \" />    <text suffix=\" \" variable=\"title\" />    <text variable=\"genre\" />  </macro>  <citation          disambiguate-add-names=\"true\"         et-al-min=\"4\"         et-al-subsequent-min=\"4\"         et-al-subsequent-use-first=\"1\"         et-al-use-first=\"1\">    <layout delimiter=\"; \" prefix=\"\" suffix=\".\">      <choose>        <if position=\"ibid-with-locator\">          <group delimiter=\", \">            <text suffix=\".\" term=\"ibid\" text-case=\"capitalize-first\" />            <text macro=\"point-locators-subsequent\" />          </group>        </if>        <else-if position=\"ibid\">          <text suffix=\".\" term=\"ibid\" text-case=\"capitalize-first\" />        </else-if>        <else-if position=\"subsequent\">          <group delimiter=\", \">            <text macro=\"contributors-short\" />            <text macro=\"title-short\" />            <text macro=\"point-locators-subsequent\" />          </group>        </else-if>        <else>          <group delimiter=\", \">            <text macro=\"contributors-note\" />            <text macro=\"title-note\" />            <text macro=\"description-note\" />            <text macro=\"secondary-contributors-note\" />            <text macro=\"container-title-note\" />            <text macro=\"container-contributors-note\" />          </group>          <text macro=\"locators-note\" />          <text macro=\"collection-title\" prefix=\", \" />          <text macro=\"issue-note\" />          <text macro=\"locators-newspaper\" prefix=\", \" />          <text macro=\"point-locators\" />          <text macro=\"access-note\" prefix=\", \" />        </else>      </choose>    </layout>  </citation>  <bibliography          entry-spacing=\"0\"         et-al-min=\"11\"         et-al-use-first=\"7\"         hanging-indent=\"true\"         subsequent-author-substitute=\"---\">    <sort>      <key macro=\"sort-key\" />      <key variable=\"issued\" />    </sort>    <layout>     <group display=\"block\" suffix=\".\"> <group delimiter=\". \">        <text macro=\"contributors\" />        <text macro=\"title\" />        <text macro=\"description\" />        <text macro=\"secondary-contributors\" />        <group delimiter=\", \">          <text macro=\"container-title\"/>          <text macro=\"container-contributors\" />          <text macro=\"locators-chapter\" />        </group>      </group>      <text macro=\"locators\" />      <text macro=\"collection-title\" prefix=\". \" />      <text macro=\"issue\" />      <text macro=\"locators-newspaper\" prefix=\", \" />      <text macro=\"locators-journal\" />      <text macro=\"access\" prefix=\". \" /> </group> </layout>  </bibliography></style>";


EditorsNotes.zotero = {};

EditorsNotes.zotero.zoteroToCSL = function(zoteroObject) {
  var cslObject = {}
    , z2csl = EditorsNotes.zotero.z2csl
    , typeMap
    , cslFieldMap
    , cslCreatorMap
    , getFieldKey

  typeMap = z2csl.find('typeMap[zType="' + zoteroObject.itemType + '"]');
  cslFieldMap = z2csl.find('cslFieldMap');
  cslCreatorMap = z2csl.find('cslCreatorMap');

  cslObject['type'] = typeMap.attr('cslType');

  getFieldKey = function(key) {
    var baseField = typeMap.find('field[value="' + key + '"]').attr('baseField');
    return baseField ? baseField : key;
  };

  $.each(zoteroObject, function(key, val) {
    var fieldKey
      , cslKey

    if (!val.length) {
      return true;
    }

    switch (key) {
    case 'itemType':
    case 'tags':
      // Not used to generate a citation
      break;
    case 'creators':
      $.each(val, function() {
        var creatorObject = {}
          , creatorType = this.creatorType
          , cslCreatorKey

        cslCreatorKey = getFieldKey(creatorType);
        if (!cslObject[cslCreatorKey]) {
          cslObject[cslCreatorKey] = [];
        }
        if (this.firstName || this.lastName) {
          creatorObject['given'] = this.firstName;
          creatorObject['family'] = this.lastName;
        } else {
          creatorObject['literal'] = this.name;
        }
        cslObject[cslCreatorKey].push(creatorObject);
      });
      break;
    case 'date':
      cslObject['issued'] = {'raw': val};
      break;
    default:
      fieldKey = getFieldKey(key);
      cslKey = cslFieldMap
        .find('fieldMap[zField="' + fieldKey + '"]')
        .attr('cslField');
      cslObject[cslKey] = val;
    }
  });

  return cslObject;
};

// Given a form created by ZoteroForm in forms.py, return one of two objects:
//   1) An array that preserves the order of fields
//   2) A normal object that doesn't
// 
// I'd previously been using the former to send to the server. The latter is
// meant to be used to pass the zotero object to the CSL engine.
EditorsNotes.zotero.zoteroFormToObject = function($form, sorted) {
  var zoteroObject = {}
    , sortedZoteroObject = {'fields': []}
    , $fields = $form.find('.zotero-entry')
    , indexes = {}

  $.each($fields, function(key, val) {
    var $field = $(val)
      , fieldKey = $field.data('zotero-key')
      , fieldValue
      , fieldObject = {}

    switch (fieldKey) {
    case 'itemType':
      fieldValue = $field.find('input:hidden').val();
      zoteroObject.itemType = fieldValue;
      sortedZoteroObject.fields.push({'itemType': fieldValue});
      break;
    case 'creators':
    case 'tags':
      if (!zoteroObject[fieldKey]) {
        zoteroObject[fieldKey] = [];
        fieldObject[fieldKey] = [];
        indexes[fieldKey] = sortedZoteroObject.fields.push(fieldObject);
      }
      fieldValue = $field.find('input:hidden').val();
      zoteroObject[fieldKey].push( JSON.parse(fieldValue) );
      sortedZoteroObject.fields[ indexes[fieldKey]-1 ].creators.push(JSON.parse(fieldValue));
      break;
    default:
      fieldValue = $field.find('textarea').val();
      zoteroObject[fieldKey] = fieldValue;
      fieldObject[fieldKey] = fieldValue;
      sortedZoteroObject.fields.push(fieldObject);
      break;
    }
  });

  return sorted ? sortedZoteroObject : zoteroObject;
};

// This is a mapping from Zotero to CSL
// https://github.com/aurimasv/z2csl/
EditorsNotes.zotero.z2csl = (function() {
  var z2cslXML = $.parseXML('' +
'<map> <zTypes> <typeMap zType="note" cslType=""> </typeMap> <typeMap zType="book" cslType="book"> <field value="title" /> <field value="abstractNote" /> <field value="series" /> <field value="seriesNumber" /> <field value="volume" /> <field value="numberOfVolumes" /> <field value="edition" /> <field value="place" /> <field value="publisher" /> <field value="date" /> <field value="numPages" /> <field value="language" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="seriesEditor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="bookSection" cslType="chapter"> <field value="title" /> <field value="abstractNote" /> <field value="bookTitle" baseField="publicationTitle" /> <field value="series" /> <field value="seriesNumber" /> <field value="volume" /> <field value="numberOfVolumes" /> <field value="edition" /> <field value="place" /> <field value="publisher" /> <field value="date" /> <field value="pages" /> <field value="language" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="bookAuthor" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="seriesEditor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="journalArticle" cslType="article-journal"> <field value="title" /> <field value="abstractNote" /> <field value="publicationTitle" /> <field value="volume" /> <field value="issue" /> <field value="pages" /> <field value="date" /> <field value="series" /> <field value="seriesTitle" /> <field value="seriesText" /> <field value="journalAbbreviation" /> <field value="language" /> <field value="DOI" /> <field value="ISSN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="reviewedAuthor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="magazineArticle" cslType="article-magazine"> <field value="title" /> <field value="abstractNote" /> <field value="publicationTitle" /> <field value="volume" /> <field value="issue" /> <field value="date" /> <field value="pages" /> <field value="language" /> <field value="ISSN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="reviewedAuthor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="newspaperArticle" cslType="article-newspaper"> <field value="title" /> <field value="abstractNote" /> <field value="publicationTitle" /> <field value="place" /> <field value="edition" /> <field value="date" /> <field value="section" /> <field value="pages" /> <field value="language" /> <field value="shortTitle" /> <field value="ISSN" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="reviewedAuthor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="thesis" cslType="thesis"> <field value="title" /> <field value="abstractNote" /> <field value="thesisType" baseField="type" /> <field value="university" baseField="publisher" /> <field value="place" /> <field value="date" /> <field value="numPages" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="letter" cslType="personal_communication"> <field value="title" /> <field value="abstractNote" /> <field value="letterType" baseField="type" /> <field value="date" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="recipient" /> </field> </typeMap> <typeMap zType="manuscript" cslType="manuscript"> <field value="title" /> <field value="abstractNote" /> <field value="manuscriptType" baseField="type" /> <field value="place" /> <field value="date" /> <field value="numPages" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="interview" cslType="interview"> <field value="title" /> <field value="abstractNote" /> <field value="date" /> <field value="interviewMedium" baseField="medium" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="interviewee" baseField="author" /> <creatorType value="contributor" /> <creatorType value="interviewer" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="film" cslType="motion_picture"> <field value="title" /> <field value="abstractNote" /> <field value="distributor" baseField="publisher" /> <field value="date" /> <field value="genre" baseField="type" /> <field value="videoRecordingFormat" baseField="medium" /> <field value="runningTime" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="director" baseField="author" /> <creatorType value="contributor" /> <creatorType value="producer" /> <creatorType value="scriptwriter" /> </field> </typeMap> <typeMap zType="artwork" cslType="graphic"> <field value="title" /> <field value="abstractNote" /> <field value="artworkMedium" baseField="medium" /> <field value="artworkSize" /> <field value="date" /> <field value="language" /> <field value="shortTitle" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="artist" baseField="author" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="webpage" cslType="webpage"> <field value="title" /> <field value="abstractNote" /> <field value="websiteTitle" baseField="publicationTitle" /> <field value="websiteType" baseField="type" /> <field value="date" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="language" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="attachment" cslType=""> <field value="title" /> <field value="accessDate" /> <field value="url" /> </typeMap> <typeMap zType="report" cslType="report"> <field value="title" /> <field value="abstractNote" /> <field value="reportNumber" baseField="number" /> <field value="reportType" baseField="type" /> <field value="seriesTitle" /> <field value="place" /> <field value="institution" baseField="publisher" /> <field value="date" /> <field value="pages" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="seriesEditor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="bill" cslType="bill"> <field value="title" /> <field value="abstractNote" /> <field value="billNumber" baseField="number" /> <field value="code" /> <field value="codeVolume" baseField="volume" /> <field value="section" /> <field value="codePages" baseField="pages" /> <field value="legislativeBody" /> <field value="session" /> <field value="history" /> <field value="date" /> <field value="language" /> <field value="url" /> <field value="accessDate" /> <field value="shortTitle" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="sponsor" baseField="author" /> <creatorType value="contributor" /> <creatorType value="cosponsor" /> </field> </typeMap> <typeMap zType="case" cslType="legal_case"> <field value="caseName" baseField="title" /> <field value="abstractNote" /> <field value="reporter" /> <field value="reporterVolume" baseField="volume" /> <field value="court" /> <field value="docketNumber" baseField="number" /> <field value="firstPage" baseField="pages" /> <field value="history" /> <field value="dateDecided" baseField="date" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="counsel" /> </field> </typeMap> <typeMap zType="hearing" cslType="bill"> <field value="title" /> <field value="abstractNote" /> <field value="committee" /> <field value="place" /> <field value="publisher" /> <field value="numberOfVolumes" /> <field value="documentNumber" baseField="number" /> <field value="pages" /> <field value="legislativeBody" /> <field value="session" /> <field value="history" /> <field value="date" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="contributor" baseField="author" /> </field> </typeMap> <typeMap zType="patent" cslType="patent"> <field value="title" /> <field value="abstractNote" /> <field value="place" /> <field value="country" /> <field value="assignee" /> <field value="issuingAuthority" /> <field value="patentNumber" baseField="number" /> <field value="filingDate" /> <field value="pages" /> <field value="applicationNumber" /> <field value="priorityNumbers" /> <field value="issueDate" baseField="date" /> <field value="references" /> <field value="legalStatus" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="inventor" baseField="author" /> <creatorType value="attorneyAgent" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="statute" cslType="legislation"> <field value="nameOfAct" baseField="title" /> <field value="abstractNote" /> <field value="code" /> <field value="codeNumber" /> <field value="publicLawNumber" baseField="number" /> <field value="dateEnacted" baseField="date" /> <field value="pages" /> <field value="section" /> <field value="session" /> <field value="history" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="email" cslType="personal_communication"> <field value="subject" baseField="title" /> <field value="abstractNote" /> <field value="date" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="language" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="recipient" /> </field> </typeMap> <typeMap zType="map" cslType="map"> <field value="title" /> <field value="abstractNote" /> <field value="mapType" baseField="type" /> <field value="scale" /> <field value="seriesTitle" /> <field value="edition" /> <field value="place" /> <field value="publisher" /> <field value="date" /> <field value="language" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="cartographer" baseField="author" /> <creatorType value="contributor" /> <creatorType value="seriesEditor" /> </field> </typeMap> <typeMap zType="blogPost" cslType="post-weblog"> <field value="title" /> <field value="abstractNote" /> <field value="blogTitle" baseField="publicationTitle" /> <field value="websiteType" baseField="type" /> <field value="date" /> <field value="url" /> <field value="accessDate" /> <field value="language" /> <field value="shortTitle" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="commenter" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="instantMessage" cslType="personal_communication"> <field value="title" /> <field value="abstractNote" /> <field value="date" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="recipient" /> </field> </typeMap> <typeMap zType="forumPost" cslType="post"> <field value="title" /> <field value="abstractNote" /> <field value="forumTitle" baseField="publicationTitle" /> <field value="postType" baseField="type" /> <field value="date" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="audioRecording" cslType="song"> <field value="title" /> <field value="abstractNote" /> <field value="audioRecordingFormat" baseField="medium" /> <field value="seriesTitle" /> <field value="volume" /> <field value="numberOfVolumes" /> <field value="place" /> <field value="label" baseField="publisher" /> <field value="date" /> <field value="runningTime" /> <field value="language" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="url" /> <field value="accessDate" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="performer" baseField="author" /> <creatorType value="composer" /> <creatorType value="contributor" /> <creatorType value="wordsBy" /> </field> </typeMap> <typeMap zType="presentation" cslType="speech"> <field value="title" /> <field value="abstractNote" /> <field value="presentationType" baseField="type" /> <field value="date" /> <field value="place" /> <field value="meetingName" /> <field value="url" /> <field value="accessDate" /> <field value="language" /> <field value="shortTitle" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="presenter" baseField="author" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="videoRecording" cslType="motion_picture"> <field value="title" /> <field value="abstractNote" /> <field value="videoRecordingFormat" baseField="medium" /> <field value="seriesTitle" /> <field value="volume" /> <field value="numberOfVolumes" /> <field value="place" /> <field value="studio" baseField="publisher" /> <field value="date" /> <field value="runningTime" /> <field value="language" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="director" baseField="author" /> <creatorType value="castMember" /> <creatorType value="contributor" /> <creatorType value="producer" /> <creatorType value="scriptwriter" /> </field> </typeMap> <typeMap zType="tvBroadcast" cslType="broadcast"> <field value="title" /> <field value="abstractNote" /> <field value="programTitle" baseField="publicationTitle" /> <field value="episodeNumber" baseField="number" /> <field value="videoRecordingFormat" baseField="medium" /> <field value="place" /> <field value="network" baseField="publisher" /> <field value="date" /> <field value="runningTime" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="director" baseField="author" /> <creatorType value="castMember" /> <creatorType value="contributor" /> <creatorType value="guest" /> <creatorType value="producer" /> <creatorType value="scriptwriter" /> </field> </typeMap> <typeMap zType="radioBroadcast" cslType="broadcast"> <field value="title" /> <field value="abstractNote" /> <field value="programTitle" baseField="publicationTitle" /> <field value="episodeNumber" baseField="number" /> <field value="audioRecordingFormat" baseField="medium" /> <field value="place" /> <field value="network" baseField="publisher" /> <field value="date" /> <field value="runningTime" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="director" baseField="author" /> <creatorType value="castMember" /> <creatorType value="contributor" /> <creatorType value="guest" /> <creatorType value="producer" /> <creatorType value="scriptwriter" /> </field> </typeMap> <typeMap zType="podcast" cslType="song"> <field value="title" /> <field value="abstractNote" /> <field value="seriesTitle" /> <field value="episodeNumber" baseField="number" /> <field value="audioFileType" baseField="medium" /> <field value="runningTime" /> <field value="url" /> <field value="accessDate" /> <field value="language" /> <field value="shortTitle" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="podcaster" baseField="author" /> <creatorType value="contributor" /> <creatorType value="guest" /> </field> </typeMap> <typeMap zType="computerProgram" cslType="book"> <field value="title" /> <field value="abstractNote" /> <field value="seriesTitle" /> <field value="version" /> <field value="date" /> <field value="system" /> <field value="place" /> <field value="company" baseField="publisher" /> <field value="programmingLanguage" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="rights" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="accessDate" /> <field value="extra" /> <field value="creator"> <creatorType value="programmer" baseField="author" /> <creatorType value="contributor" /> </field> </typeMap> <typeMap zType="conferencePaper" cslType="paper-conference"> <field value="title" /> <field value="abstractNote" /> <field value="date" /> <field value="proceedingsTitle" baseField="publicationTitle" /> <field value="conferenceName" /> <field value="place" /> <field value="publisher" /> <field value="volume" /> <field value="pages" /> <field value="series" /> <field value="language" /> <field value="DOI" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="seriesEditor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="document" cslType=""> <field value="title" /> <field value="abstractNote" /> <field value="publisher" /> <field value="date" /> <field value="language" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="reviewedAuthor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="encyclopediaArticle" cslType="entry-encyclopedia"> <field value="title" /> <field value="abstractNote" /> <field value="encyclopediaTitle" baseField="publicationTitle" /> <field value="series" /> <field value="seriesNumber" /> <field value="volume" /> <field value="numberOfVolumes" /> <field value="edition" /> <field value="place" /> <field value="publisher" /> <field value="date" /> <field value="pages" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="language" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="seriesEditor" /> <creatorType value="translator" /> </field> </typeMap> <typeMap zType="dictionaryEntry" cslType="entry-dictionary"> <field value="title" /> <field value="abstractNote" /> <field value="dictionaryTitle" baseField="publicationTitle" /> <field value="series" /> <field value="seriesNumber" /> <field value="volume" /> <field value="numberOfVolumes" /> <field value="edition" /> <field value="place" /> <field value="publisher" /> <field value="date" /> <field value="pages" /> <field value="language" /> <field value="ISBN" /> <field value="shortTitle" /> <field value="url" /> <field value="accessDate" /> <field value="archive" /> <field value="archiveLocation" /> <field value="libraryCatalog" /> <field value="callNumber" /> <field value="rights" /> <field value="extra" /> <field value="creator"> <creatorType value="author" /> <creatorType value="contributor" /> <creatorType value="editor" /> <creatorType value="seriesEditor" /> <creatorType value="translator" /> </field> </typeMap> </zTypes> <cslFieldMap> <fieldMap zField="title" cslField="title" /> <fieldMap zField="publicationTitle" cslField="container-title" /> <fieldMap zField="reporter" cslField="container-title" /> <fieldMap zField="code" cslField="container-title" /> <fieldMap zField="seriesTitle" cslField="collection-title" /> <fieldMap zField="series" cslField="collection-title" /> <fieldMap zField="seriesNumber" cslField="collection-number" /> <fieldMap zField="publisher" cslField="publisher" /> <fieldMap zField="distributor" cslField="publisher" /> <fieldMap zField="place" cslField="publisher-place" /> <fieldMap zField="court" cslField="authority" /> <fieldMap zField="pages" cslField="page" /> <fieldMap zField="volume" cslField="volume" /> <fieldMap zField="issue" cslField="issue" /> <fieldMap zField="numberOfVolumes" cslField="number-of-volumes" /> <fieldMap zField="numPages" cslField="number-of-pages" /> <fieldMap zField="edition" cslField="edition" /> <fieldMap zField="version" cslField="version" /> <fieldMap zField="section" cslField="section" /> <fieldMap zField="type" cslField="genre" /> <fieldMap zField="artworkSize" cslField="genre" /> <fieldMap zField="medium" cslField="medium" /> <fieldMap zField="system" cslField="medium" /> <fieldMap zField="archive" cslField="archive" /> <fieldMap zField="archiveLocation" cslField="archive_location" /> <fieldMap zField="meetingName" cslField="event" /> <fieldMap zField="conferenceName" cslField="event" /> <fieldMap zField="place" cslField="event-place" /> <fieldMap zField="abstractNote" cslField="abstract" /> <fieldMap zField="url" cslField="URL" /> <fieldMap zField="DOI" cslField="DOI" /> <fieldMap zField="ISBN" cslField="ISBN" /> <fieldMap zField="callNumber" cslField="call-number" /> <fieldMap zField="extra" cslField="note" /> <fieldMap zField="number" cslField="number" /> <fieldMap zField="history" cslField="references" /> <fieldMap zField="shortTitle" cslField="shortTitle" /> <fieldMap zField="journalAbbreviation" cslField="journalAbbreviation" /> <fieldMap zField="language" cslField="language" /> <fieldMap zField="date" cslField="issued" /> <fieldMap zField="accessDate" cslField="accessed" /> </cslFieldMap> <cslCreatorMap> <creatorMap zCreator="author" cslCreator="author" /> <creatorMap zCreator="editor" cslCreator="editor" /> <creatorMap zCreator="bookAuthor" cslCreator="container-author" /> <creatorMap zCreator="composer" cslCreator="composer" /> <creatorMap zCreator="interviewer" cslCreator="interviewer" /> <creatorMap zCreator="recipient" cslCreator="recipient" /> <creatorMap zCreator="seriesEditor" cslCreator="collection-editor" /> <creatorMap zCreator="translator" cslCreator="translator" /> </cslCreatorMap> </map>');

  return $(z2cslXML);

})();

$.fn.zotero = function(options) {
  var zoteroContainer = this
    , settings
    , toolbar
    , descriptionEdit
    , initArchiveAutocomplete

  settings = $.extend({
    'description': '#id_description'
  }, options);

  toolbar = ''
    + '<div id="description-toolbar" class="btn-toolbar" style="display: none;">'
    +   '<div class="btn-group">'
    +     '<a data-wysihtml5-command="bold" class="btn"><i class="icon-bold"></i></a>'
    +   '</div>'
    +   '<div class="btn-group">'
    +     '<a data-wysihtml5-command="italic" class="btn"><i class="icon-italic"></i></a>'
    +   '</div>'
    +   '<div class="pull-right">'
    +     '<a data-wysihtml5-command="generateCitation" class="btn">Generate citation</a>'
    +     '<span>Autoupdate? </span><input type="checkbox" class="autoupdate-toggle" />'
    +   '</div>'
    + '</div>'

  descriptionEdit = $(settings.description).before(toolbar);

  wysihtml5.commands.generateCitation = {
    exec: function(composer, command, param) {
      var CSL = zoteroContainer.data('asCslObject')
        , citation = EditorsNotes.CSL.makeCitation(CSL)
      if (citation.search(/reference with no printed form/) > -1) {
        citation = '';
      }
      composer.setValue(citation);
    },
    state: function() { return false; },
    value: function() { return undefined; }
  }

  initArchiveAutocomplete = function() {
    $('[data-zotero-key="archive"] textarea', zoteroContainer).autocomplete({
      source: function(request, response) {
        $.getJSON('/api/document/archives/', {'q': request.term}, function(data) {
          response($.map(data, function(item, index) {
            return { label: item.name };
          }));
        });
      }
    });
  }

  if (!EditorsNotes.CSL.hasOwnProperty('makeCitation')) {
    EditorsNotes.CSL.makeCitation = EditorsNotes.CSL.createCSLEngine('chicago_fullnote_bibliography2');
  }

  return this.each(function() {
    var editor = new wysihtml5.Editor(settings.description.slice(1), {
      toolbar: 'description-toolbar',
      parserRules: wysihtml5ParserRules,
      stylesheets: ['/static/function/wysihtml5/stylesheet.css']
    });

    editor
      .on('change:composer', function() {
        $('input.autoupdate-toggle').attr('checked', false).trigger('change');
      })
      .on('load', function() {
        if (editor.getValue() === '') {
          $('input.autoupdate-toggle').attr('checked', true).trigger('change');
        }
      });

    zoteroContainer.data('editor', editor);

    $('body')
      .on('change', 'input.autoupdate-toggle', 'change', function() {
        zoteroContainer.toggleClass('autoupdate-citation', this.checked);
      })

    initArchiveAutocomplete();

    zoteroContainer
      .on('input change', function() {
        var zoteroObject = EditorsNotes.zotero.zoteroFormToObject(zoteroContainer)
          , CSLObject = EditorsNotes.zotero.zoteroToCSL(zoteroObject)

        zoteroContainer
          .data('asZoteroObject', zoteroObject)
          .data('asCslObject', CSLObject)

        if (zoteroContainer.hasClass('autoupdate-citation')) {
          editor.composer.commands.exec('generateCitation');
        }

      })
      // Get template for form when item type selected
      .on('change', 'select[name="item-type-select"]', function() {
        var $itemTypeSelect = $(this)
          , itemType = $itemTypeSelect.val()

        if (!itemType.length) { return; }
        $.ajax({
          url: '/api/document/template/',
          data: {'itemType': itemType},
          success: function(data) {
            zoteroContainer
              .data('itemTypeSelect', $itemTypeSelect.parents('.control-group'))
              .html($(data).closest('#zotero-information-edit').html())
              .find('.zotero-entry-delete')
                .remove();
            initArchiveAutocomplete();
          }
        });
      })

      // Update creators' hidden inputs as they're changed
      .on('input change', '.zotero-creator', function() {
        var $this = $(this)
          , creatorObject = {};
        $this
          .find('.creator-attr').each(function() {
            creatorObject[$(this).data('creator-key')] = this.value;
          });
        $this
          .find('input:hidden')
          .val(JSON.stringify(creatorObject));
      })

      // Buttons for adding/removing creators
      .on('click', '.zotero-creator .add-creator', function() {
        var $oldCreator = $(this).parents('.zotero-creator'),
          $newCreator = $oldCreator.clone(true, true).insertAfter($oldCreator);
        $newCreator.find('textarea').val('').trigger('input');
      })
      .on('click', '.zotero-creator .remove-creator', function() {
        var $thisRow = $(this).parents('.zotero-creator');
        if ($thisRow.siblings('.zotero-creator').length) {
          $thisRow.remove();
        }
      })

  });
}
